<?php
include 'auth.php';
include 'head.php'; 

// Load the JSON file generated by the Python script
$predictionFile = 'predictions/predicted_restock.json';

if (file_exists($predictionFile)) {
    $predictionData = json_decode(file_get_contents($predictionFile), true);
    $insertedCount = 0;

    foreach ($predictionData as $prediction) {
        // Skip items where no restock is needed
        if ($prediction['PredictedRestockDate'] == null || $prediction['PredictedQuantity'] <= 0) {
            continue;
        }

        // Extract item prediction details
        $itemID = $prediction['ItemID'];
        $predictedRestockDate = $prediction['PredictedRestockDate'];
        $predictedQuantity = $prediction['PredictedQuantity'];

        // Check if the prediction already exists in the database to avoid duplicates
        $checkQuery = "SELECT * FROM Prediction WHERE ItemID = ? AND PredictedRestockDate = ?";
        if ($checkStmt = $con->prepare($checkQuery)) {
            $checkStmt->bind_param("is", $itemID, $predictedRestockDate);
            $checkStmt->execute();
            $checkStmt->store_result();

            // If no record exists, insert the new prediction
            if ($checkStmt->num_rows == 0) {
                $insertQuery = "INSERT INTO Prediction (ItemID, PredictedRestockDate, PredictedQuantity) VALUES (?, ?, ?)";
                if ($stmt = $con->prepare($insertQuery)) {
                    $stmt->bind_param("isi", $itemID, $predictedRestockDate, $predictedQuantity);

                    if ($stmt->execute()) {
                        $insertedCount++;
                    } else {
                        echo "Error inserting prediction for ItemID $itemID: " . $stmt->error . "<br>";
                    }

                    $stmt->close();
                } else {
                    echo "Error preparing insert statement: " . $con->error . "<br>";
                }
            }

            $checkStmt->close();
        } else {
            echo "Error preparing check statement: " . $con->error . "<br>";
        }
    }

    // Show alert and redirect to predictive_analysis.php
    echo "<script>
        alert('Predictions processed successfully. $insertedCount new records inserted.');
        window.location.href = 'predictive_analysis.php';
    </script>";
} else {
    echo "<script>
        alert('No prediction data found.');
        window.location.href = 'predictive_analysis.php';
    </script>";
}

$con->close();
?>
